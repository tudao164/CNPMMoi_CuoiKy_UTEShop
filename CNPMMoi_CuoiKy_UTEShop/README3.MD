# üîê Admin API Documentation - UTEShop

## T·ªïng Quan

H·ªá th·ªëng Admin API cho ph√©p qu·∫£n tr·ªã vi√™n qu·∫£n l√Ω to√†n b·ªô h·ªá th·ªëng bao g·ªìm: S·∫£n ph·∫©m, Ng∆∞·ªùi d√πng, v√† ƒê∆°n h√†ng.

### Y√™u C·∫ßu
- **Authentication**: Bearer Token (JWT)
- **Authorization**: User ph·∫£i c√≥ `is_admin = TRUE`
- **Header**: `Authorization: Bearer <your_jwt_token>`

### Login Admin

**Endpoint:** `POST /api/auth/login`

```json
{
    "email": "admin@uteshop.com",
    "password": "admin123"
}
```

**Response:**
```json
{
    "success": true,
    "data": {
        "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
        "user": {
            "id": 1,
            "email": "admin@uteshop.com",
            "full_name": "Admin User",
            "is_admin": true,
            "is_verified": true
        }
    }
}
```

---

## üì¶ Qu·∫£n L√Ω S·∫£n Ph·∫©m (Admin Product Management)

### 1. L·∫•y T·∫•t C·∫£ S·∫£n Ph·∫©m (Bao G·ªìm Inactive)

**Endpoint:** `GET /api/admin/products`

**Query Parameters:**
- `page` (number): S·ªë trang (default: 1)
- `limit` (number): S·ªë s·∫£n ph·∫©m/trang (default: 20)
- `category_id` (number): L·ªçc theo danh m·ª•c
- `search` (string): T√¨m ki·∫øm theo t√™n/m√¥ t·∫£
- `is_active` (boolean): L·ªçc theo tr·∫°ng th√°i (true/false)
- `stock_status` (string): L·ªçc theo t·ªìn kho (out_of_stock, low_stock, in_stock)

**Example:**
```
GET /api/admin/products?page=1&limit=20&is_active=true&stock_status=low_stock
```

---

### 2. Th·ªëng K√™ S·∫£n Ph·∫©m

**Endpoint:** `GET /api/admin/products/stats`

**Response:**
```json
{
    "success": true,
    "data": {
        "stats": {
            "total_products": 50,
            "active_products": 45,
            "inactive_products": 5,
            "out_of_stock": 3,
            "low_stock": 7,
            "in_stock": 35,
            "on_sale": 12,
            "total_sold": 1250,
            "total_views": 45678
        }
    }
}
```

---

### 3. T·∫°o S·∫£n Ph·∫©m M·ªõi


**Tr∆∞·ªõc khi t·∫°o s·∫£n ph·∫©m m·ªõi, c√≥ th·ªÉ th√™m b∆∞·ªõc upload h√¨nh ·∫£nh l√™n server qua endpoint `/api/admin/uploads` ƒë·ªÉ l·∫•y URL h√¨nh ·∫£nh.**
**Endpoint:** POST http://localhost:3000/api/upload/single
**Headers:**
Authorization: Bearer <your_admin_token>
Content-Type: multipart/form-data
Key: image
Type: File
Value: Ch·ªçn file h√¨nh ·∫£nh t·ª´ m√°y t√≠nh
Description: Upload h√¨nh ·∫£nh s·∫£n ph·∫©m

Return
```json
{
    "success": true,
    "message": "Upload ·∫£nh th√†nh c√¥ng",
    "data": {
        "image_url": "/images/59_3_185007f6d7a04bc48c27427464a1a906_master-1760974240718-223872938.jpg",
        "filename": "59_3_185007f6d7a04bc48c27427464a1a906_master-1760974240718-223872938.jpg",
        "size": 341257,
        "mimetype": "image/jpeg"
    },
    "timestamp": "2025-10-20T15:30:40.724Z"
}
```

Sau khi upload nh∆∞ tr√™n h√¨nh xong c√≥ th·ªÉ v√†o http://localhost:3000/images/59_3_185007f6d7a04bc48c27427464a1a906_master-1760974240718-223872938.jpg
ƒê·ªÉ xem ·∫£nh ƒë√£ upload th√†nh c√¥ng.

**Endpoint:** `POST /api/admin/products`

T·∫°o s·∫£n ph·∫©m v·ªõi link ·∫£nh nh∆∞ ·ªü tr√™n ƒë√£ l√†m
**Request Body:**
```json
{
    "name": "iPhone 16 Pro Max",
    "description": "Latest iPhone with A18 chip",
    "price": 1299.99,
    "sale_price": 1199.99,
    "stock_quantity": 100,
    "category_id": 1,
    "image_url": "/images/59_3_185007f6d7a04bc48c27427464a1a906_master-1760974240718-223872938.jpg",
    "images": ["/images/59_3_185007f6d7a04bc48c27427464a1a906_master-1760974240718-223872938.jpg"],
    "specifications": {
        "screen": "6.7 inch",
        "chip": "A18 Pro",
        "camera": "48MP"
    },
    "is_featured": true
}
```

---

### 4. C·∫≠p Nh·∫≠t S·∫£n Ph·∫©m

**Endpoint:** `PUT /api/admin/products/:id`

**Request Body:** (T·∫•t c·∫£ fields ƒë·ªÅu optional)
```json
{
    "name": "iPhone 16 Pro Max - Updated",
    "price": 1249.99,
    "stock_quantity": 150,
    "is_active": true
}
```

---

### 5. X√≥a S·∫£n Ph·∫©m (Soft Delete)

**Endpoint:** `DELETE /api/admin/products/:id`

*S·∫£n ph·∫©m s·∫Ω ƒë∆∞·ª£c ƒë√°nh d·∫•u `is_active = FALSE` thay v√¨ x√≥a vƒ©nh vi·ªÖn*

---

### 6. K√≠ch Ho·∫°t S·∫£n Ph·∫©m

**Endpoint:** `PATCH /api/admin/products/:id/activate`

*ƒê·∫∑t l·∫°i `is_active = TRUE` cho s·∫£n ph·∫©m ƒë√£ b·ªã x√≥a*

---

### 7. C·∫≠p Nh·∫≠t T·ªìn Kho

**Endpoint:** `PATCH /api/admin/products/:id/stock`

**Request Body:**
```json
{
    "stock_quantity": 200
}
```

---

## üë• Qu·∫£n L√Ω Ng∆∞·ªùi D√πng (Admin User Management)

### 1. L·∫•y T·∫•t C·∫£ Ng∆∞·ªùi D√πng

**Endpoint:** `GET /api/admin/users`

**Query Parameters:**
- `page` (number): S·ªë trang
- `limit` (number): S·ªë users/trang
- `search` (string): T√¨m theo email ho·∫∑c t√™n

**Example:**
```
GET /api/admin/users?page=1&limit=20&search=nguyen
```

---

### 2. Th·ªëng K√™ Ng∆∞·ªùi D√πng

**Endpoint:** `GET /api/admin/users/stats`

**Response:**
```json
{
    "success": true,
    "data": {
        "stats": {
            "total_users": 1500,
            "verified_users": 1350,
            "new_users_30d": 120,
            "new_users_7d": 25,
            "admin_count": 3,
            "users_today": 5
        }
    }
}
```

---

### 3. Xem Chi Ti·∫øt Ng∆∞·ªùi D√πng

**Endpoint:** `GET /api/admin/users/:id`

**Response:**
```json
{
    "success": true,
    "data": {
        "user": {
            "id": 2,
            "email": "user@example.com",
            "full_name": "Nguyen Van A",
            "phone": "0987654321",
            "is_admin": false,
            "is_verified": true
        },
        "stats": {
            "total_orders": 15,
            "total_spent": 5000000,
            "last_order_date": "2024-01-15T10:30:00.000Z"
        }
    }
}
```

---

### 4. T·∫°o Ng∆∞·ªùi D√πng M·ªõi

**Endpoint:** `POST /api/admin/users`

**Request Body:**
```json
{
    "email": "newuser@example.com",
    "password": "password123",
    "full_name": "Tran Van B",
    "phone": "0901234567",
    "is_admin": false,
    "is_verified": true
}
```

---

### 5. C·∫≠p Nh·∫≠t Ng∆∞·ªùi D√πng

**Endpoint:** `PUT /api/admin/users/:id`

**Request Body:**
```json
{
    "full_name": "Tran Van B Updated",
    "phone": "0912345678",
    "is_verified": true,
    "is_admin": false
}
```

---

### 6. X√≥a Ng∆∞·ªùi D√πng

**Endpoint:** `DELETE /api/admin/users/:id`

**L∆∞u √Ω:**
- Kh√¥ng th·ªÉ x√≥a ch√≠nh m√¨nh
- Kh√¥ng th·ªÉ x√≥a user c√≥ ƒë∆°n h√†ng

---

### 7. ƒê·∫∑t L·∫°i M·∫≠t Kh·∫©u

**Endpoint:** `PATCH /api/admin/users/:id/password`

**Request Body:**
```json
{
    "new_password": "newpassword123"
}
```

---

### 8. B·∫≠t/T·∫Øt Quy·ªÅn Admin

**Endpoint:** `PATCH /api/admin/users/:id/toggle-admin`

*Kh√¥ng c·∫ßn body, t·ª± ƒë·ªông toggle is_admin gi·ªØa TRUE/FALSE*

**L∆∞u √Ω:**
- Admin kh√¥ng th·ªÉ toggle quy·ªÅn c·ªßa ch√≠nh m√¨nh

---

## üì¶ Qu·∫£n L√Ω ƒê∆°n H√†ng (Admin Order Management)

### 1. L·∫•y T·∫•t C·∫£ ƒê∆°n H√†ng

**Endpoint:** `GET /api/admin/orders`

**Query Parameters:**
- `page`, `limit`: Ph√¢n trang
- `status`: L·ªçc theo tr·∫°ng th√°i (new, confirmed, preparing, shipping, delivered, cancelled)
- `payment_method`: L·ªçc theo ph∆∞∆°ng th·ª©c thanh to√°n (COD, E_WALLET)
- `payment_status`: L·ªçc theo tr·∫°ng th√°i thanh to√°n (pending, paid, failed, refunded)
- `user_id`: L·ªçc theo ng∆∞·ªùi d√πng
- `date_from`, `date_to`: L·ªçc theo ng√†y (YYYY-MM-DD)

**Example:**
```
GET /api/admin/orders?status=new&payment_method=COD&date_from=2024-01-01&date_to=2024-01-31
```

---

### 2. Th·ªëng K√™ ƒê∆°n H√†ng

**Endpoint:** `GET /api/admin/orders/stats`

**Query Parameters:**
- `date_from`, `date_to`: Kho·∫£ng th·ªùi gian th·ªëng k√™

**Response:**
```json
{
    "success": true,
    "data": {
        "stats": {
            "total_orders": 1000,
            "new_orders": 50,
            "confirmed_orders": 100,
            "preparing_orders": 80,
            "shipping_orders": 120,
            "delivered_orders": 600,
            "cancelled_orders": 50,
            "cancel_requested_orders": 5,
            "total_revenue": 500000000,
            "completed_revenue": 450000000,
            "average_order_value": 500000,
            "orders_today": 25,
            "revenue_today": 12500000,
            "payment_breakdown": [
                {
                    "payment_method": "COD",
                    "count": 600,
                    "total_amount": 300000000
                },
                {
                    "payment_method": "E_WALLET",
                    "count": 400,
                    "total_amount": 200000000
                }
            ]
        }
    }
}
```

---

### 3. Xem Chi Ti·∫øt ƒê∆°n H√†ng

**Endpoint:** `GET /api/admin/orders/:id`

**Response:**
```json
{
    "success": true,
    "data": {
        "order": {
            "id": 1,
            "user_id": 2,
            "user_email": "user@example.com",
            "user_name": "Nguyen Van A",
            "total_amount": 1799.98,
            "status": "confirmed",
            "payment_method": "COD",
            "payment_status": "pending",
            "shipping_address": "123 ABC Street"
        },
        "items": [
            {
                "id": 1,
                "product_id": 1,
                "product_name": "iPhone 15 Pro",
                "quantity": 2,
                "price": 899.99
            }
        ],
        "history": [
            {
                "id": 1,
                "status": "new",
                "notes": "ƒê∆°n h√†ng ƒë∆∞·ª£c t·∫°o",
                "changed_by_name": null,
                "created_at": "2024-01-01T10:00:00.000Z"
            },
            {
                "id": 2,
                "status": "confirmed",
                "notes": "T·ª± ƒë·ªông x√°c nh·∫≠n",
                "changed_by_name": "System",
                "created_at": "2024-01-01T10:30:00.000Z"
            }
        ]
    }
}
```

---

### 4. C·∫≠p Nh·∫≠t Tr·∫°ng Th√°i ƒê∆°n H√†ng

**Endpoint:** `PATCH /api/admin/orders/:id/status`

**Request Body:**
```json
{
    "status": "shipping",
    "notes": "ƒê∆°n h√†ng ƒëang ƒë∆∞·ª£c giao ƒë·∫øn ƒë·ªãa ch·ªâ"
}
```

**Valid Status Transitions:**
- `new` ‚Üí `confirmed`, `cancelled`
- `confirmed` ‚Üí `preparing`, `cancelled`
- `preparing` ‚Üí `shipping`, `cancelled`
- `shipping` ‚Üí `delivered`, `cancelled`
- `delivered` ‚Üí (final state)
- `cancelled` ‚Üí (final state)
- `cancel_requested` ‚Üí `cancelled`, `confirmed`

---

### 5. Xu·∫•t D·ªØ Li·ªáu ƒê∆°n H√†ng

**Endpoint:** `GET /api/admin/orders/export`

**Query Parameters:**
- `date_from`, `date_to`: Kho·∫£ng th·ªùi gian
- `status`: L·ªçc theo tr·∫°ng th√°i

**Response:** JSON array c·ªßa t·∫•t c·∫£ ƒë∆°n h√†ng ph√π h·ª£p

---

### 6. X√≥a ƒê∆°n H√†ng (Ch·ªâ Cancelled Orders)

**Endpoint:** `DELETE /api/admin/orders/:id`

**L∆∞u √Ω:** Ch·ªâ c√≥ th·ªÉ x√≥a ƒë∆°n h√†ng ƒë√£ h·ªßy

---

## üö´ Qu·∫£n L√Ω Y√™u C·∫ßu H·ªßy ƒê∆°n (Admin-only Endpoints)

### 1. L·∫•y Danh S√°ch Y√™u C·∫ßu Ch·ªù X·ª≠ L√Ω

**Endpoint:** `GET /api/cancel-requests/admin/pending`

**Query Parameters:**
- `page`, `limit`: Ph√¢n trang

---

### 2. Th·ªëng K√™ Y√™u C·∫ßu H·ªßy ƒê∆°n (To√†n H·ªá Th·ªëng)

**Endpoint:** `GET /api/cancel-requests/admin/stats`

**Query Parameters:**
- `start_date`, `end_date`: Kho·∫£ng th·ªùi gian

---

### 3. X·ª≠ L√Ω Y√™u C·∫ßu H·ªßy ƒê∆°n

**Endpoint:** `POST /api/cancel-requests/:id/process`

**Request Body:**
```json
{
    "status": "approved",
    "admin_response": "Ch·∫•p thu·∫≠n y√™u c·∫ßu h·ªßy ƒë∆°n v√¨ l√Ω do h·ª£p l√Ω"
}
```

**Status values:** `approved` ho·∫∑c `rejected`

---

## üîí Error Responses

### Kh√¥ng C√≥ Token
```json
{
    "success": false,
    "message": "Token kh√¥ng ƒë∆∞·ª£c cung c·∫•p",
    "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### Kh√¥ng Ph·∫£i Admin
```json
{
    "success": false,
    "message": "Ch·ªâ admin m·ªõi c√≥ th·ªÉ truy c·∫≠p ch·ª©c nƒÉng n√†y",
    "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### Token H·∫øt H·∫°n
```json
{
    "success": false,
    "message": "Token ƒë√£ h·∫øt h·∫°n",
    "timestamp": "2024-01-01T00:00:00.000Z"
}
```

---

## üìù Notes

1. **T·∫•t c·∫£ Admin endpoints ƒë·ªÅu y√™u c·∫ßu:**
   - JWT Token h·ª£p l·ªá
   - User ph·∫£i c√≥ `is_admin = TRUE`

2. **Rate Limiting:** 
   - 100 requests / 15 ph√∫t cho m·ªói IP

3. **Pagination:**
   - Default: `page=1`, `limit=20`
   - Max limit: 100

4. **Date Format:**
   - ISO 8601: `YYYY-MM-DD` ho·∫∑c `YYYY-MM-DDTHH:mm:ss.sssZ`

5. **Admin Safety:**
   - Admin kh√¥ng th·ªÉ x√≥a ch√≠nh m√¨nh
   - Admin kh√¥ng th·ªÉ thu h·ªìi quy·ªÅn admin c·ªßa ch√≠nh m√¨nh

---

## üéØ Quick Start

### 1. C·∫≠p nh·∫≠t database (n·∫øu ch∆∞a c√≥ is_admin column)
```bash
node update-database.js
```

### 2. T·∫°o/Reset admin password
```bash
node create-admin.js
```

### 3. Login as Admin
```bash
POST /api/auth/login
{
    "email": "admin@uteshop.com",
    "password": "admin123"
}
```

### 4. S·ª≠ d·ª•ng token trong c√°c request ti·∫øp theo
```
Authorization: Bearer <your_token_from_login>
```

---

## üìß Support

N·∫øu c√≥ v·∫•n ƒë·ªÅ, vui l√≤ng li√™n h·ªá dev team.
